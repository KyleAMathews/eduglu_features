<?php

include_once('eduglu_core.features.inc');

/**
 * Implementation of hook_menu().
 */
function eduglu_core_menu() {
  $items['eduglu_front_page_redirect'] = array(
    'title' => "redirecting...",
    'description' => t('Just a handy redirect tool'),
    'page callback' => 'eduglu_core_redirect',
    'access callback' => 'user_access',
    'access arguments' => array('access content'),
  );

  return $items;
}

/**
 * Redirect authenticated users to their dashboard away from the welcome page.
 */
function eduglu_core_redirect() {
  global $user;
  if ($user->uid == 0) {
    drupal_goto("welcome");
  }
  else {
    drupal_goto("dashboard");
  }
}

/**
 * Implementation of hook_menu_alter().
 */
function eduglu_core_menu_alter(&$items) {
  // Kill undesirable menu items
  $yank = array(
    'book',
    'rss.xml',
    'node/%node/outline',
  );
  foreach ($yank as $path) {
    if (!empty($items[$path])) {
      unset($items[$path]);
    }
  }
}

function eduglu_core_form_alter(&$form, &$form_state, $form_id) {
//dpm($form_id);
//dpm($form);
//dpm($form_state);
  switch ($form_id) {
    // Redirect people to dashboard after logging in from the front page.
    case 'user_login_block':
      $form['#action'] = url("welcome", array('query' => array('destination' => 'dashboard')));
      break;

    // Hide the eduglu_welcome + spaces_dashboard features in groups as they're
    // not useful there.
    case 'spaces_features_form':
      $space = spaces_get_space();
      if ($space->type == "og") {
        unset($form['spaces_features']['eduglu_welcome']);
        unset($form['labels']['eduglu_welcome']);
        unset($form['settings']['eduglu_welcome']);
        unset($form['spaces_features']['spaces_dashboard']);
        unset($form['labels']['spaces_dashboard']);
        unset($form['settings']['spaces_dashboard']);
      }
  }

  if ($form['#id'] == "node-form") {
    // Remove group public checkbox. 
    if (isset($form['og_nodeapi'])) {
      _eduglu_core_make_hidden($form['og_nodeapi']);
    }
    // Even if you have the perms, we don't want you messing with this stuff
    $disable = array('menu', 'comment_settings');
    foreach ($disable as $key) {
      if (!empty($form[$key])) {
        $form[$key]['#access'] = FALSE;
      }
    }
  }
}

/**
 * Set all elements in a given form to 'value'. Using value preserves the tree and prevents
 * The element from being rendered.
 */
function _eduglu_core_make_hidden(&$form) {
  if (isset($form['#type'])) {
    $form['#type'] = 'value';
    $form['#required'] = FALSE;
  }
  if (is_array($form)) {
    foreach ($form as $key => $value) {
      if (is_array($value) && strpos($key, '#') !== 0) {
        _eduglu_core_make_hidden($form[$key]);
      }
    }
  }
}

